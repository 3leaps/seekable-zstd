name: Build Artifacts

on:
  workflow_dispatch:
  push:
    tags:
      - "v*"

jobs:
  build-linux:
    name: Build Linux Libs
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-unknown-linux-gnu,aarch64-unknown-linux-gnu,x86_64-unknown-linux-musl,aarch64-unknown-linux-musl

      - name: Install cargo-zigbuild
        run: |
          pip install ziglang
          cargo install cargo-zigbuild

      - name: Build AMD64
        run: |
          # glibc (2.17 for broad compatibility)
          cargo zigbuild --release --target x86_64-unknown-linux-gnu.2.17 -p seekable-zstd-core
          # musl
          cargo zigbuild --release --target x86_64-unknown-linux-musl -p seekable-zstd-core

      - name: Build ARM64
        run: |
          # glibc (2.17)
          cargo zigbuild --release --target aarch64-unknown-linux-gnu.2.17 -p seekable-zstd-core
          # musl
          cargo zigbuild --release --target aarch64-unknown-linux-musl -p seekable-zstd-core

      - name: Organize Artifacts
        run: |
          mkdir -p dist/linux-amd64
          cp target/x86_64-unknown-linux-gnu.2.17/release/libseekable_zstd_core.a dist/linux-amd64/

          mkdir -p dist/linux-amd64-musl
          cp target/x86_64-unknown-linux-musl/release/libseekable_zstd_core.a dist/linux-amd64-musl/

          mkdir -p dist/linux-arm64
          cp target/aarch64-unknown-linux-gnu.2.17/release/libseekable_zstd_core.a dist/linux-arm64/

          mkdir -p dist/linux-arm64-musl
          cp target/aarch64-unknown-linux-musl/release/libseekable_zstd_core.a dist/linux-arm64-musl/

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-libs
          path: dist/*

  build-macos:
    name: Build macOS Libs
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-apple-darwin,aarch64-apple-darwin

      - name: Build
        env:
          # Build for broad compatibility.
          MACOSX_DEPLOYMENT_TARGET: "11.0"
        run: |
          cargo build --release --target x86_64-apple-darwin -p seekable-zstd-core
          cargo build --release --target aarch64-apple-darwin -p seekable-zstd-core

      - name: Organize Artifacts
        run: |
          mkdir -p dist/darwin-amd64
          cp target/x86_64-apple-darwin/release/libseekable_zstd_core.a dist/darwin-amd64/

          mkdir -p dist/darwin-arm64
          cp target/aarch64-apple-darwin/release/libseekable_zstd_core.a dist/darwin-arm64/

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-libs
          path: dist/*

  build-windows:
    name: Build Windows Libs
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-pc-windows-gnu

      - name: Install cargo-zigbuild
        run: |
          pip install ziglang
          cargo install cargo-zigbuild

      - name: Build AMD64
        run: |
          cargo zigbuild --release --target x86_64-pc-windows-gnu -p seekable-zstd-core

      - name: Organize Artifacts
        run: |
          mkdir -p dist/windows-amd64
          cp target/x86_64-pc-windows-gnu/release/libseekable_zstd_core.a dist/windows-amd64/

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-libs
          path: dist/*

  commit-artifacts:
    name: Commit Artifacts
    needs: [build-linux, build-macos, build-windows]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 1

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: download-libs

      - name: Organize artifacts
        run: |
          # The download-artifact action downloads to download-libs/{artifact-name}/*
          # We need to move them to bindings/go/lib/{arch}/

          # Linux
          cp -r download-libs/linux-libs/* bindings/go/lib/

          # macOS
          cp -r download-libs/macos-libs/* bindings/go/lib/

          # Windows
          cp -r download-libs/windows-libs/* bindings/go/lib/

          echo "Artifact structure:"
          ls -R bindings/go/lib

      - name: Commit and Push
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore: update pre-built static libraries"
          file_pattern: "bindings/go/lib/**"
