name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read

env:
  BINDIR: ${{ github.workspace }}/.bin
  SFETCH_CACHE_DIR: ${{ github.workspace }}/.cache/sfetch
  # Pinned tool versions.
  # Note: CI currently uses the official `install-sfetch.sh` entrypoint.
  # If/when we support version pinning for the installer, wire this through.
  SFETCH_VERSION: v0.2.8
  GONEAT_VERSION: v0.3.20

jobs:
  tools:
    name: Tools (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]

    steps:
      - uses: actions/checkout@v4

      # Prefer a GitHub App token when available; fall back to the default workflow token.
      # This keeps tokens short-lived and scoped.
      - name: Mint GitHub App token (optional)
        id: app-token
        # `secrets.*` is not available in `if:` expressions. Gate on fork PRs instead.
        if: >-
          ${{ github.event_name != 'pull_request' ||
          github.event.pull_request.head.repo.full_name == github.repository }}
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.CI_GH_APP_ID }}
          private-key: ${{ secrets.CI_GH_APP_PRIVATE_KEY }}

      - name: Configure CI auth token
        shell: bash
        env:
          TOKEN: ${{ steps.app-token.outputs.token || github.token }}
        run: |
          set -euo pipefail
          {
            echo "GITHUB_TOKEN=$TOKEN"
            echo "GH_TOKEN=$TOKEN"
          } >> "$GITHUB_ENV"

      - name: Install trust prerequisites (Linux)
        if: runner.os == 'Linux'
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends ca-certificates curl minisign

      - name: Install trust prerequisites (macOS)
        if: runner.os == 'macOS'
        shell: bash
        run: |
          set -euo pipefail
          brew install minisign

      - uses: actions/cache@v4
        with:
          path: ${{ env.SFETCH_CACHE_DIR }}
          key: ${{ runner.os }}-sfetch-cache-${{ env.SFETCH_VERSION }}-${{ env.GONEAT_VERSION }}

      - name: Install sfetch (trust anchor)
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p "$BINDIR" "$SFETCH_CACHE_DIR"

          # The official installer uses the GitHub Releases API to discover the latest version.
          # Under parallel CI fan-out this can hit secondary rate limiting (403/429).
          # For CI, install from pinned release assets and verify via minisign.

          case "$(uname -s)" in
            Darwin*) os=darwin ;;
            Linux*) os=linux ;;
            *) echo "unsupported OS: $(uname -s)"; exit 1 ;;
          esac

          case "$(uname -m)" in
            x86_64|amd64) arch=amd64 ;;
            arm64|aarch64) arch=arm64 ;;
            *) echo "unsupported arch: $(uname -m)"; exit 1 ;;
          esac

          platform="${os}_${arch}"
          archive="sfetch_${platform}.tar.gz"
          base_url="https://github.com/3leaps/sfetch/releases/download/${SFETCH_VERSION}"

          auth=()
          if [ -n "${GITHUB_TOKEN:-}" ]; then
            auth=(-H "Authorization: Bearer ${GITHUB_TOKEN}")
          fi

          tmpdir="$(mktemp -d)"
          trap 'rm -rf "${tmpdir}"' EXIT

          curl -sSfL --retry 5 --retry-all-errors --retry-delay 2 "${auth[@]}" \
            -o "${tmpdir}/SHA256SUMS" "${base_url}/SHA256SUMS"
          curl -sSfL --retry 5 --retry-all-errors --retry-delay 2 "${auth[@]}" \
            -o "${tmpdir}/SHA256SUMS.minisig" "${base_url}/SHA256SUMS.minisig"
          curl -sSfL --retry 5 --retry-all-errors --retry-delay 2 "${auth[@]}" \
            -o "${tmpdir}/${archive}" "${base_url}/${archive}"

          pubkey_file="${tmpdir}/sfetch-minisign.pub"
          echo "untrusted comment: sfetch release signing key" >"${pubkey_file}"
          echo "RWTAoUJ007VE3h8tbHlBCyk2+y0nn7kyA4QP34LTzdtk8M6A2sryQtZC" >>"${pubkey_file}"

          minisign -Vm "${tmpdir}/SHA256SUMS" -p "${pubkey_file}" >/dev/null

          expected="$(grep "${archive}" "${tmpdir}/SHA256SUMS" | head -1 | cut -d' ' -f1)"
          if [ -z "${expected}" ]; then
            echo "missing checksum for ${archive}"; exit 1
          fi

          if command -v sha256sum >/dev/null 2>&1; then
            actual="$(sha256sum "${tmpdir}/${archive}" | cut -d' ' -f1)"
          else
            actual="$(shasum -a 256 "${tmpdir}/${archive}" | cut -d' ' -f1)"
          fi

          if [ "${actual}" != "${expected}" ]; then
            echo "checksum mismatch for ${archive}"; exit 1
          fi

          tar -xzf "${tmpdir}/${archive}" -C "${tmpdir}"
          cp "${tmpdir}/sfetch" "${BINDIR}/sfetch"
          chmod +x "${BINDIR}/sfetch"

          "${BINDIR}/sfetch" --self-verify

      - name: Install goneat (verified)
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p "$BINDIR" "$SFETCH_CACHE_DIR"

          # GitHub can intermittently return 403/429 under parallel CI load
          # (secondary rate limiting / abuse detection). Since this is a
          # public, signed artifact fetch, a short retry with backoff is OK.
          for attempt in 1 2 3 4 5; do
            if "$BINDIR/sfetch" --repo fulmenhq/goneat \
              --tag "$GONEAT_VERSION" \
              --dest-dir "$BINDIR" \
              --cache-dir "$SFETCH_CACHE_DIR" \
              --require-minisign; then
              break
            fi

            sleep_seconds=$((attempt * 5))
            echo "sfetch failed (attempt $attempt); sleeping ${sleep_seconds}s..."
            sleep "$sleep_seconds"
          done

          "$BINDIR/goneat" --version

      - name: Upload tools artifact
        uses: actions/upload-artifact@v4
        with:
          name: ci-tools-${{ matrix.os }}
          if-no-files-found: error
          path: |
            ${{ env.BINDIR }}/sfetch
            ${{ env.BINDIR }}/goneat

  test:
    name: Test (${{ matrix.os }}, rust ${{ matrix.rust }})
    needs: tools
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
        rust: [stable, "1.88"]

    steps:
      - uses: actions/checkout@v4

      - name: Download tools artifact
        uses: actions/download-artifact@v4
        with:
          name: ci-tools-${{ matrix.os }}
          path: ${{ env.BINDIR }}

      - name: Activate tools
        shell: bash
        run: |
          set -euo pipefail
          chmod +x "$BINDIR/sfetch" "$BINDIR/goneat"
          echo "$BINDIR" >> "$GITHUB_PATH"

      - name: Validate goneat tools config
        shell: bash
        run: |
          set -euo pipefail
          "$BINDIR/goneat" doctor tools --validate-config

      - uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ matrix.rust }}
          components: rustfmt, clippy

      - uses: actions/setup-go@v5
        with:
          go-version: "1.22"

      - uses: actions/setup-node@v4
        with:
          node-version: "20"

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Rust fmt
        run: cargo fmt -- --check

      - name: Rust clippy
        run: cargo clippy -- -D warnings

      - name: Rust tests
        run: cargo test

      - name: Build Rust static lib for Go tests
        shell: bash
        run: |
          set -euo pipefail
          os="$(uname -s | tr '[:upper:]' '[:lower:]')"
          arch="$(uname -m)"
          case "$arch" in
            x86_64) arch=amd64 ;;
            aarch64|arm64) arch=arm64 ;;
            *) echo "unsupported arch: $arch"; exit 1 ;;
          esac

          cargo build --release -p seekable-zstd-core

          lib_dir="bindings/go/lib/local/${os}-${arch}"
          mkdir -p "$lib_dir"
          cp "target/release/libseekable_zstd_core.a" "$lib_dir/libseekable_zstd_core.a"

      - name: Go vet
        run: cd bindings/go && go vet ./...

      - name: Go tests (CGO)
        run: cd bindings/go && CGO_ENABLED=1 go test ./...

      - name: Python tests
        shell: bash
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          python -m pip install uv
          cd crates/seekable-zstd-py
          uv sync --dev
          uv run maturin develop
          uv run pytest

      - name: Node.js tests
        shell: bash
        run: |
          set -euo pipefail
          cd bindings/nodejs
          npm ci
          npm run build
          npm test
